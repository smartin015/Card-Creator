<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition Card Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/main.css' rel='stylesheet' type='text/css'>
    <link href='css/print.css' rel='stylesheet' type='text/css' media="print">
  </head>

  <body>
    <div id="loading" style="color: white; font-size: 24px;">LOADING....</div>

    <header id="toggleButtons" style="margin-bottom: 0.1in;">
      <button id="showAll">Show All</button>
    </header>

    <script id="character-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="title">{{ Title }}</div>
          <div class="indicators">
            <div class="health">{{ Health }}H</div>
          </div>
        </header>
        <article>
          {{#if Special}}
            <div class="special">Specials: {{ Special }}</div>
          {{/if}}
        </article>
        <footer>
          <div class="cardType">{{ cardType }}</div>
        </footer>
      </div>
    </script>

    <script id="npc-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="tier">{{romanize Tier }}</div>
          <div class="title">{{ Title }}</div>
          <div class="indicators">
            <div class="health">{{ Health }}H</div>
          </div>
        </header>
        <article>
          {{#if Immune}}
            <div class="info">Immune to <span class="immune">{{ Immune }}</span></div>
          {{/if}}
          {{#if Special}}
            <div class="special">Specials: {{ Special }}</div>
          {{/if}}
        </article>
        <footer>
          <div class="cardType">{{ cardType }}</div>
        </footer>
      </div>
    </script>

    <script id="ability-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="stat"><img src="img/{{ Stat }}.svg"/></div>
          <div class="indicators">
            {{#if Health}}
              <div class="health">{{ Health }}H</div>
            {{else}}{{#if Damage}}
              <div class="damage">{{ Damage }}</div>
            {{else}}
              <div class="damage">-</div>
            {{/if}}{{/if}}
            {{#if Risk}}
              <div class="risk">{{ Risk }}</div>
            {{/if}}
          </div>
          <div class="title">{{ Title }}</div>
        </header>
        <article>
          <div class="info"><span class="type">{{ Type }}</span> - <span class="target">{{ Target }}</span></div>
          {{#if Requires}}<div class="requires">Requires {{ Requires }}</div>{{/if}}
          <div class="effect">{{ Effect }}</div>
          <div class="usage">{{ Usage }}</div>
          <div class="roleplay"><div class="prompt">Describe:</div>{{ Describe }}</div>
        </article>
        <footer>
          <div class="cardType">{{ cardType }}</div>
        </footer>
      </div>
    </script>

    <script id="passive-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="stat"><img src="img/{{ Stat }}.svg"/></div>
          <div class="title">{{ Title }}</div>
          <div class="indicators">
            <div class="value">+{{ Value }}</div>
          </div>
        </header>
        <article>
          <div class="effect">{{ Effect }}</div>
        </article>
        <footer>
          <div class="cardType">{{ cardType }}</div>
        </footer>
      </div>
    </script>

    <script id="equipment-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="stat"><img src="img/{{ Stat }}.svg"/></div>
          <div class="title">{{ Title }}</div>
          <div class="indicators">
            {{#if Health}}
              <div class="health">{{ Health }}H</div>
            {{else}}{{#if Value}}
              <div class="value">+{{ Value }}</div>
            {{else}}
              <div class="value">-</div>
            {{/if}}{{/if}}
          </div>
        </header>
        <article>
          <div class="info"><span class="type">{{ Type }}</span></div>
          <div class="effect">{{ Effect }}</div>
          <div class="roleplay"><div class="prompt">Describe:</div>{{ Describe }}</div>
        </article>
        <footer>
          <div class="slot">{{ Slot }}</div>
          <div class="cardType">{{ cardType }}</div>
          <div class="worth">{{ Worth }} gold</div>
        </footer>
      </div>
    </script>

    <script id="item-template" type="text/x-handlebars-template">
      <div class="card {{ cardType }}">
        <header>
          <div class="title">{{ Title }}</div>
        </header>
        <article>
          <div class="info"><span class="type">{{ Type }}</span></div>
          <div class="effect">{{ Effect }}</div>
          <div class="description">{{ Description }}</div>
        </article>
        <footer>
          <div class="cardType">{{ cardType }}</div>
          <div class="worth">{{ Worth }} gold</div>
        </footer>
      </div>
    </script>

    <script id="back-template" type="text/x-handlebars-template">
      <div class="card back {{ cardType }}">
        <div class="stat">{{#if Stat}}<img src="img/{{ Stat }}.svg"/>{{/if}}</div>
        <div class="cardType">{{ cardType }}</div>
      </div>
    </script>

    

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/jquery.query.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/tabletop.js"></script>
    <!--<script src="js/svg.js"></script>-->
    <script>
    Handlebars.registerHelper("romanize", function(num) {
      if (!+num) return false; // http://blog.stevenlevithan.com/archives/javascript-roman-numeral-converter
      var digits = String(+num).split(""),
          key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                 "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                 "","I","II","III","IV","V","VI","VII","VIII","IX"],
          roman = "",
          i = 3;
      while (i--) roman = (key[+digits.pop() + (i * 10)] || "") + roman;
      return Array(+digits.join("") + 1).join("M") + roman;
    });

    var templates = { // will be rendered into UI in this order
      Character: Handlebars.compile($("#character-template").html()),
      NPC: Handlebars.compile($("#npc-template").html()),
      Ability: Handlebars.compile($("#ability-template").html()),
      Passive: Handlebars.compile($("#passive-template").html()),
      Equipment: Handlebars.compile($("#equipment-template").html()),
      Item: Handlebars.compile($("#item-template").html())
    };
    backTemplate = Handlebars.compile($("#back-template").html());

    $(function() {
      Tabletop.init({
        key: '1WvRrQUBRSZS6teOcbnCjAqDr-ubUNIxgiVwWGDcsZYM',
        callback: function(data, tabletop) {
          // We're done loading!
          $("#loading").remove();
          // Sort sheets alphabetically
          var sheets = tabletop.sheets(),
              sorted = [];
          for (var key in templates) {
            sorted[sorted.length] = key;
          }
          for (var i = 0, l = sorted.length; i < l; i++) {
            sorted[i] = sheets[sorted[i]];
          }
          // iterate through and display
          $.each(sorted, function(i, sheet) {
            if (templates[sheet.name]) {
              console.log(sheet.name, sheet.column_names);
              makeToggleButton(sheet.name);
              makeCards(sheet.name, sheet.elements);
            }
          });
          if ($.query.get('filter')) { $("#filter" + $.query.get('filter')).click(); }
        }, simpleSheet: true
      });
        
      // replace all .svg img tags with actual SVG
      // SVGInjector(document.querySelectorAll('img.svg'), {});
      $("#showAll").click(function() {
        $(".card").show();
        history.replaceState({}, document.title, "?");
      });
    });

    function makeCards(template, cards) {
      var fronts, backs, rendered = 0;
      for (var i = 0, l = cards.length; i < l; i++) {
        var card = cards[i];
        if (card.Comment !== "") { continue; }
        if (rendered % 6 === 0) { // new page
          fronts = $('<div class="page fronts"></div>');
          backs = $('<div class="page backs"></div>');
          $("body").append(fronts);
          $("body").append(backs);
        }
        for (var property in card) {
          if (card[property] === '-') { card[property] = ''; }
        }
        card.cardType = template;
        fronts.append(templates[template](card));
        backs.append(backTemplate(card));
        rendered++;
      }
    }

    function makeToggleButton(title) {
      var b = $("<button>Only " + title + "</button>");
      b.attr('id', 'filter' + title);
      b.click(function(e) {
        $(".card").hide();
        $("." + title).show();
        history.replaceState({}, document.title, $.query.set('filter', title).toString());
      });
      $("#toggleButtons").append(b);
    }
    </script>
    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
  </body>
</html>