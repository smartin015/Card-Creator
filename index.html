<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition Card Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/main.css' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <div id="loading" style="color: white; font-size: 24px;">LOADING....</div>

    <script id="abilities-template" type="text/x-handlebars-template">
      <div class="card ability">
        <div class="contents">
          <header>
            <div class="title"><div class="stat"><img src="img/{{ Stat }}.svg"/></div>{{ Title }}</div>
            <div class="indicators">
              {{#if Health}}
                <div class="health">{{ Health }}H</div>
              {{else}}{{#if Value}}
                <div class="damage">+{{ Damage }}</div>
              {{else}}
                <div class="damage">-</div>
              {{/if}}{{/if}}
              {{#if Risk}}
                <div class="risk">{{ Risk }}</div>
              {{/if}}
            </div>
          </header>
          <div class="info"><span class="type">{{ Type }}</span> - <span class="target">{{ Target }}</span></div>
          <div class="effect">{{ Effect }}</div>
          <div class="usage">{{ Usage }}</div>
          <div class="roleplay"><div class="prompt">Describe:</div>{{ Describe }}</div>
        </div>
      </div>
    </script>

    <script id="equipment-template" type="text/x-handlebars-template">
      <div class="card equipment">
        <div class="contents">
          <header>
            <div class="title"><div class="stat"><img src="img/{{ Stat }}.svg"/></div>{{ Title }}</div>
            <div class="indicators">
              {{#if Health}}
                <div class="health">{{ Health }}H</div>
              {{else}}{{#if Value}}
                <div class="value">+{{ Value }}</div>
              {{else}}
                <div class="value">-</div>
              {{/if}}{{/if}}
            </div>
          </header>
          <div class="info"><span class="type">{{ Type }}</span></div>
          <div class="effect">{{ Effect }}</div>
          <div class="roleplay"><div class="prompt">Describe:</div>{{ Describe }}</div>
        </div>
      </div>
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/tabletop.js"></script>
    <script src="js/svg.js"></script>
    <script>
    var templates = {
      Abilities: Handlebars.compile($("#abilities-template").html()),
      Equipment: Handlebars.compile($("#equipment-template").html())
    };

    $(function() {
      Tabletop.init({
        key: '1WvRrQUBRSZS6teOcbnCjAqDr-ubUNIxgiVwWGDcsZYM',
        callback: function(data, tabletop) {
          // We're done loading!
          $("#loading").remove();
          // Sort sheets alphabetically
          var sheets = tabletop.sheets(),
              sorted = [];
          for (var key in sheets) {
            sorted[sorted.length] = key;
          }
          sorted.sort();
          for (var i = 0, l = sorted.length; i < l; i++) {
            sorted[i] = sheets[sorted[i]];
          }
          // iterate through and display
          $.each(sorted, function(i, sheet) {
            console.log(sheet.name, sheet.column_names);
            makeCards(templates[sheet.name], sheet.elements);
          });
        }, simpleSheet: true
      });
        
      // replace all .svg img tags with actual SVG
      // SVGInjector(document.querySelectorAll('img.svg'), {}); 
    });

    function makeCards(template, cards) {
      for (var i = 0, l = cards.length; i < l; i++) {
        var card = cards[i];
        if (card.Comment !== "") { continue; }
        console.log(card);
        for (var property in card) {
          if (card[property] === '-') { card[property] = ''; }
        }
        $("body").append(template(card));
      }
    }
    </script>
    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
  </body>
</html>