<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/game.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id="players">
    </div>
    <div id="dm">
      <button id="pausePlay">PAUSE</button>
      <table>
        <tr id="enemies"></tr>
      </table>
    </div>

    <script id="player-template" type="text/x-handlebars-template">
      <div class="player" data-player="{{ player }}" style="background: {{ color }};">
        <div class="info">
          <h2>{{ name }}</h2>
          <h1 class="damage number">0</h1>
        </div>
      </div>
    </script>

    <script id="enemy-template" type="text/x-handlebars-template">
      <td class="enemy" data-tier="{{ tier }}">
        <div class="label">Tier {{ romanTier }}: <span class="count number">0</span></div>
        <div class="controls">
          <button class="minus control">-</button>
          <button class="plus control">+</button>
        </div>
      </td>
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/jquery.query.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/randomColor.js"></script>
    <script>

    // SET UP UI
    var player = Handlebars.compile($("#player-template").html()),
        enemy = Handlebars.compile($("#enemy-template").html());
    function romanize(num) {
      if (!+num) return false; // http://blog.stevenlevithan.com/archives/javascript-roman-numeral-converter
      var digits = String(+num).split(""),
          key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                 "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                 "","I","II","III","IV","V","VI","VII","VIII","IX"],
          roman = "",
          i = 3;
      while (i--) roman = (key[+digits.pop() + (i * 10)] || "") + roman;
      return Array(+digits.join("") + 1).join("M") + roman;
    }

    var players = [],
        names = $.query.get('players') || (prompt("Enter player names:", "Player 1,Player 2,Player 3,Player 4") || "Player 1,Player 2,Player 3,Player 4").split(','),
        colors = randomColors(names.length);
    history.replaceState({}, document.title, $.query.set('players', names).toString());
    for (var i = 0, j = names.length; i < j; i++) {
      players.push(0);
      var el = $(player({
        name: names[i].replace(/\+/g, ' '),
        player: i,
        color: colors[i]
      }));
      $("#players").append(el);
    }
      
    var enemies = [];
    for (var i = 0, j = $.query.get('enemies')||3; i < j; i++) { enemies.push(0); }

    var attackInterval = 500, // how many ms between attack calculations, an upper limit on attack rate
        attackSpeed = 20000, // how many ms between one enemy's attacks
        attackRatio = attackInterval / attackSpeed; // odds of one enemy attacking on an individual check

    for (var i in enemies) {
      $("#enemies").append(enemy({
        tier: +(i),
        romanTier: romanize(+(i)+1)
      }));
    }

    console.log($("body").height(), $("#dm").height(), $("#players").height())
    $("#players").height($("body").height() - $("#dm").height());
    $(".player").height($("#players").height() / Math.ceil(players.length/2));



    // WIRE UI

    $(".control").click(function() {
      var tier = +$(this).closest('.enemy').data('tier');
      enemies[tier] = $(this).hasClass("plus") ? enemies[tier] + 1 : Math.max(enemies[tier] - 1, 0);
      $(this).closest('.enemy').find(".count").html(enemies[tier]);
    });

    $(".player").click(function() {
      var player = +$(this).data('player')-1;
      players[player] = 0;
      $(this).find(".damage").html(players[player]);
    });

    var paused = false;
    $("#pausePlay").click(function() {
      paused = !paused;
      if (paused) { $(this).html('RESUME'); }
      else { $(this).html('PAUSE'); }
    })

    setInterval(checkForAttack, attackInterval);
    function checkForAttack() { // probability of attack on any given second
      if (paused) return;

      var enemyCount = 0,
          check = 0,
          rand = Math.random();
      for (var tier in enemies) {
        enemyCount += enemies[tier];
      }
      console.log(enemyCount, rand, 1 - enemyCount * attackRatio)
      if (rand >  1 - enemyCount * attackRatio) {
        rand = Math.round(Math.random() * enemyCount);
        for (var t in enemies) {
          check += enemies[+(t)];
          if (rand <= check) {
            attack(+(t)+1);
            return;
          }
        }
      }
    }
    function attack(d) {
      var rand = Math.floor(Math.random() * players.length);
      players[rand] += d;
      console.log("Damaging player " + rand)
      console.log(players);
      $(".player[data-player='" + (rand) + "'] .damage").html(players[rand]);
    }
    </script>
    <script src="js/fastclick.js"></script>
    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
  </body>
</html>