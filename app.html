<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/app.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  </head>
  <body>
    <div id="party">
      <div id="partyDamage">0</div>
    </div>
    <div id="dm">
      <button id="pausePlay">BEGIN!</button>
      <table>
        <tr id="enemies"></tr>
      </table>
    </div>
    <div id="overlay">
      <div id="surge">
        <img id="surgeIcon" src="/img/dead.svg" />
        <h1>TIER I SURGE</h1>
        <p>The game is paused. Resolve an enemy surge, then tap to close.</p>
      </div>
    </div>

    <script id="enemy-template" type="text/x-handlebars-template">
      <td class="enemy" data-tier="{{ tier }}">
        <div class="label">{{ romanTier }}</div>
        <div class="controls">
          <div class="plus control"><i class="fa fa-chevron-circle-up"></i></div>
          <div class="count number">0</div>
          <div class="minus control"><i class="fa fa-chevron-circle-down"></i></div>
        </div>
      </td>
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/jquery.query.js"></script>
    <script src="js/handlebars.js"></script>
    <script>
// SETTINGS
    var attackSpeed = 20000, // ms between one enemy's attacks
        surgeSpeed = 60000; // ms between global enemy surges

// STATE
    var paused = true, // if game is paused
        partyDamage = 0, // amount of damage shown
        surgeTimer;

    // sounds from Soundbible and https://www.sounddogs.com/results.asp?Type=1&CategoryID=1024&SubcategoryID=62
    var audio = {
      reset: [
        'audio/reset-1.mp3'
      ],
      damage: [
        'audio/damage-0.mp3',
        'audio/damage-1.mp3',
        'audio/damage-2.mp3',
        'audio/damage-3.mp3'
      ]
    };

// LOAD HANDLEBARS
    var enemy = Handlebars.compile($("#enemy-template").html());
    function romanize(num) { // http://blog.stevenlevithan.com/archives/javascript-roman-numeral-converter
      if (!+num) return false;
      var digits = String(+num).split(""),
          key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                 "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                 "","I","II","III","IV","V","VI","VII","VIII","IX"],
          roman = "",
          i = 3;
      while (i--) roman = (key[+digits.pop() + (i * 10)] || "") + roman;
      return Array(+digits.join("") + 1).join("M") + roman;
    }
    
// INIT ENEMIES
    var tiers = 5,
        enemies = []; // enemies are a list of attack intervals that are cleared / appended to
    for (var i = 0; i < tiers; i++) {
      enemies.push([]);
      $("#enemies").append(enemy({
        tier: +(i),
        romanTier: romanize(+(i)+1)
      }));
    }
    function addEnemy(tier) {
      var count = enemies[tier].length;
      enemies[tier].push({
        'attack': setTimeout(function() {
          attack(tier, count);
        }, attackSpeed*Math.random())
      });
    }
    function removeEnemy(tier) {
      var t = enemies[tier];
      if (t.length === 0) return;

      clearTimeout(t[t.length-1].attack);
      enemies[tier] = t.slice(0, -1);
    }
    function attack(tier, i) {
      addDamage((tier+1));
      enemies[tier][i].attack = setTimeout(function() {
        attack(tier, i);
      }, attackSpeed*(1.1-Math.round(Math.random()*20)/100)); // +/- 10% of attackSpeed
    }

// SURGE!
    function showSurge() {
      $("#overlay").fadeIn();
      $("#surge").show();
      paused = true;
    }
    $("#overlay").click(function() {
      $("#overlay").fadeOut();
      $("#surge").hide();
      paused = false;
      surgeTimer = setTimeout(showSurge, surgeSpeed);
    })

// INIT THE PARTYY
    function addDamage(d) {
      if (paused) { return; }

      partyDamage += d;
      new Audio(audio.damage[Math.floor(Math.random()*audio.damage.length)]).play();
      flashOverlay('damage', function() {
        $('#partyDamage').html(partyDamage);
      });
    }
    function resetDamage() {
      partyDamage = 0;
      new Audio(audio.reset[Math.floor(Math.random()*audio.reset.length)]).play();
      flashOverlay('reset', function() {
        $('#partyDamage').html(partyDamage);
      });
    }
    function flashOverlay(cl, cb) {
      $("#overlay").show().addClass(cl);
      setTimeout(function() {
        $("#overlay").hide().removeClass(cl);
        cb();
      }, 150);
    }

// WIRE CONTROLS
    $(".control").click(function() {
      var tier = +$(this).closest('.enemy').data('tier');
      if ($(this).hasClass("plus")) {
        addEnemy(tier);
      } else {
        removeEnemy(tier);
      }
      $(this).closest('.enemy').find(".count").html(enemies[tier].length);
    });

    $("#party").click(function() {
      resetDamage();
    });

    $("#pausePlay").click(function() {
      paused = !paused;
      if (paused) {
        $(this).html('RESUME');
        clearTimeout(surgeTimer);
      } else {
        $(this).html('PAUSE');
        surgeTimer = setTimeout(showSurge, surgeSpeed);
      }
    })
    </script>
    <script src="js/fastclick.js"></script>
    <!--<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>-->
  </body>
</html>