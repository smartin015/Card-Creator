<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/game.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id="players">
    </div>
    <div id="dm">
      <button id="pausePlay">PAUSE</button>
      <table>
        <tr id="enemies"></tr>
      </table>
    </div>

    <script id="player-template" type="text/x-handlebars-template">
      <div class="player" data-player="{{ player }}" style="background: {{ color }};">
        <button class="killToggle" data-player="{{ player }}">KO&#39;d</button>
        <div class="info">
          <h2>{{ name }}</h2>
          <h1 class="damage number">0</h1>
        </div>
      </div>
    </script>

    <script id="enemy-template" type="text/x-handlebars-template">
      <td class="enemy" data-tier="{{ tier }}">
        <div class="label">Tier {{ romanTier }}: <span class="count number">0</span></div>
        <div class="controls">
          <button class="minus control">-</button>
          <button class="plus control">+</button>
        </div>
      </td>
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/jquery.query.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/randomColor.js"></script>
    <script>

    // sounds from Soundbible and https://www.sounddogs.com/results.asp?Type=1&CategoryID=1024&SubcategoryID=62
    var audio = {
      reset: [
        'audio/reset-1.mp3'
      ],
      damage: [
        'audio/damage-0.mp3',
        'audio/damage-1.mp3',
        'audio/damage-2.mp3',
        'audio/damage-3.mp3'
      ]
    };

    // SET UP UI
    var player = Handlebars.compile($("#player-template").html()),
        enemy = Handlebars.compile($("#enemy-template").html());
    function romanize(num) {
      if (!+num) return false; // http://blog.stevenlevithan.com/archives/javascript-roman-numeral-converter
      var digits = String(+num).split(""),
          key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                 "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                 "","I","II","III","IV","V","VI","VII","VIII","IX"],
          roman = "",
          i = 3;
      while (i--) roman = (key[+digits.pop() + (i * 10)] || "") + roman;
      return Array(+digits.join("") + 1).join("M") + roman;
    }

    var players = [], playerTotals = [], lastAttacked = null, deadPlayers = [],
        names = $.query.get('players') || (prompt("Enter player names:", "Player 1,Player 2,Player 3,Player 4") || "Player 1,Player 2,Player 3,Player 4").split(','),
        colors = randomColors(names.length);
    history.replaceState({}, document.title, $.query.set('players', names).toString());
    for (var i = 0, j = names.length; i < j; i++) {
      players.push(0);
      playerTotals.push(0);
      var el = $(player({
        name: names[i].replace(/\+/g, ' '),
        player: i,
        color: colors[i]
      }));
      $("#players").append(el);
    }
      
    var enemies = [];
    for (var i = 0, j = $.query.get('enemies')||3; i < j; i++) { enemies.push(0); }

    var attackInterval = 500, // how many ms between attack calculations, an upper limit on attack rate
        attackSpeed = 20000, // how many ms between one enemy's attacks
        attackRatio = attackInterval / attackSpeed; // odds of one enemy attacking on an individual check

    for (var i in enemies) {
      $("#enemies").append(enemy({
        tier: +(i),
        romanTier: romanize(+(i)+1)
      }));
    }

    $("#players").height($("body").height() - $("#dm").height());
    $(".player").height($("#players").height() / Math.ceil(players.length/2));



    // WIRE UI

    $(".control").click(function() {
      var tier = +$(this).closest('.enemy').data('tier');
      enemies[tier] = $(this).hasClass("plus") ? enemies[tier] + 1 : Math.max(enemies[tier] - 1, 0);
      $(this).closest('.enemy').find(".count").html(enemies[tier]);
    });

    $(".player").click(function() {
      var el = $(this),
          player = +el.data('player');

      if (players[player] > 0) {
        players[player] = 0;
        el.find(".damage").html(players[player]);
        new Audio(audio.reset[Math.floor(Math.random()*audio.reset.length)]).play();
        el.addClass('reset');
        setTimeout(function() {
          el.removeClass('reset');
        }, 100);
      }
    });

    $(".killToggle").click(function(e) {
      var el = $(this),
          player = +el.data('player');

      if (deadPlayers.indexOf(player) !== -1) { // they're dead - revive
        deadPlayers.splice(deadPlayers.indexOf(player), 1);
        el.closest(".player").removeClass("dead");
        el.html("KO&#39;d");
      } else {
        deadPlayers.push(player);
        el.closest(".player").addClass("dead");
        el.html("Revive");
        if (deadPlayers.length === players.length) {
          alert("Your whole party has been knocked out");
          window.location.reload();
        }
      }
    });

    var paused = false;
    $("#pausePlay").click(function() {
      paused = !paused;
      if (paused) { $(this).html('RESUME'); }
      else { $(this).html('PAUSE'); }
    })

    checkForAttack();
    function checkForAttack() { // probability of attack on any given second
      setTimeout(checkForAttack, Math.round(attackInterval-100+Math.random()*100));
      if (paused) return;

      var enemyCount = 0,
          check = 0,
          rand = Math.random();
      for (var tier in enemies) {
        enemyCount += enemies[tier];
      }
      if (rand >  1 - enemyCount * attackRatio) {
        rand = Math.round(Math.random() * enemyCount);
        for (var t in enemies) {
          check += enemies[+(t)];
          if (rand <= check) {
            attack(+(t)+1);
            return;
          }
        }
      }
    }
    function attack(d) {
      var rand;
      do {
        rand = Math.floor(Math.random() * players.length);
      } while (deadPlayers.indexOf(rand) !== -1);
      // reduce odds of attacking the same person 2x in a row by re-rolling
      // if (rand === lastAttacked) { rand = Math.floor(Math.random() * players.length); }
      // lastAttacked = rand;

      var el = $(".player[data-player='" + (rand) + "']");
      players[rand] += d;
      playerTotals[rand] += d;
      console.log("Damaging player " + rand + " for " + d + " - they've taken " + playerTotals[rand] + " damage so far");
      el.find(".damage").html(players[rand]);
      new Audio(audio.damage[Math.floor(Math.random()*audio.damage.length)]).play();
      el.addClass('damage');
        setTimeout(function() {
          el.removeClass('damage');
        }, 100);
    }
    </script>
    <!--<script src="js/fastclick.js"></script>-->
    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
  </body>
</html>