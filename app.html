<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Expedition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href='css/app.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  </head>
  <body>
    <div id="party">
      <div id="partyContents">
        <div id="surgeText"></div>
        <div id="partyDamage">0</div>
      </div>
    </div>
    <div id="dm">
      <!--<button id="nextRound">BEGIN!</button>-->
      <table>
        <tr id="enemies"></tr>
      </table>
    </div>
    <div id="overlay">
      <div id="overlayText">
        <img id="combatIcon" class="svg" src="/img/encounter.svg" />
        <h1>COMBAT</h1>
        <h1 id="combatTimer"><span id="combatTimerValue"></span>s</h1>
        <p>Tap to end round</p>
      </div>
    </div>

    <script id="enemy-template" type="text/x-handlebars-template">
      <td class="enemy" data-tier="{{ tier }}">
        <div class="label">{{ romanTier }}</div>
        <div class="controls">
          <div class="plus control"><i class="fa fa-chevron-circle-up"></i></div>
          <div class="count number">0</div>
          <div class="minus control"><i class="fa fa-chevron-circle-down"></i></div>
        </div>
      </td>
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/jquery.query.js"></script>
    <script src="js/handlebars.js"></script>
    <script>
// SETTINGS
    var roundSpeed = 10000, // max combat round length before party starts taking penalties
        attackSpeed = 15000, // ms between one enemy's attacks; tweaks tier damage output
        surgeSpeed = 60000; // ms between global enemy surges; tweaks how often surges happen

// STATE
    var partyDamage = 0, // amount of damage shown
        roundStarted = null; // Date.now() of when current round started

    var audio = { // sounds from Soundbible and https://www.sounddogs.com/results.asp?Type=1&CategoryID=1024&SubcategoryID=62
      reset: [
        'audio/reset-1.mp3'
      ],
      damage: [
        'audio/damage-0.mp3',
        'audio/damage-1.mp3',
        'audio/damage-2.mp3',
        'audio/damage-3.mp3'
      ]
    };

// LOAD HANDLEBARS
    var enemy = Handlebars.compile($("#enemy-template").html());
    function romanize(num) { // http://blog.stevenlevithan.com/archives/javascript-roman-numeral-converter
      if (!+num) return false;
      var digits = String(+num).split(""),
          key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                 "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                 "","I","II","III","IV","V","VI","VII","VIII","IX"],
          roman = "",
          i = 3;
      while (i--) roman = (key[+digits.pop() + (i * 10)] || "") + roman;
      return Array(+digits.join("") + 1).join("M") + roman;
    }
    
// INIT ENEMIES
    var tiers = 5,
        enemies = [0]; // tier "0" always blank
    for (var i = 1; i <= tiers; i++) {
      enemies.push(0);
      $("#enemies").append(enemy({
        tier: i,
        romanTier: romanize(i)
      }));
    }
    function addEnemy(tier) {
      enemies[tier]++;
      $(".enemy[data-tier=" + tier +"]").find(".count").html(enemies[tier]);
    }
    function removeEnemy(tier) {
      enemies[tier] = Math.max(0, enemies[tier]-1);
      $(".enemy[data-tier=" + tier +"]").find(".count").html(enemies[tier]);
    }
    $(".control").click(function() {
      var tier = +$(this).closest('.enemy').data('tier');
      if ($(this).hasClass("plus")) { addEnemy(tier); }
      else { removeEnemy(tier); }
    });
    function sumOfTiers() {
      var ret = 0;
      for (var i = 1; i <= tiers; i++) {
        ret += enemies[i];
      }
      return ret;
    }

// INIT ROUNDS
    $("#party").click(startRound);
    $("#overlay").click(endRound);

    function startRound() {
      $("#partyDamage").html(0);
      $("#surgeText").html("");
      $("#overlay").fadeIn();
      roundStarted = Date.now();
      roundTimer = setInterval(updateTimer, 25);
    }
    function endRound() {
// TODO
// decide if surge (using the surgeSpeed setting)
  // if surge, show in UI
// updateTime if < 0, show zero and start flashing damage icon + sound (how often? 10% change per function call?)
  
      clearInterval(updateTimer);
      var duration = Date.now() - roundStarted,
        penaltyTime = Math.max(0, duration-roundSpeed),
        standardTime = (duration - penaltyTime),
        multiplier = 0.5 + 0.5*standardTime/roundSpeed + 2*penaltyTime/roundSpeed,
        damage = Math.round(sumOfTiers()*attackSpeed/roundSpeed * multiplier * (1.1-0.2*Math.random()));
        // ^^ enemy attack power, accounting for attack speed, multiplier by round time multiplier, with +/- 10% randomness

      console.log(duration, penaltyTime, standardTime);

//      $("#surgeText").html("Tier 1 Surge");
      $("#partyDamage").html(damage);
      console.log('Time ellapsed: ' + duration + 'ms. Sum of tiers: ' + sumOfTiers() + ', damage dealt: ' + damage + ' @' + multiplier + 'x');

      $("#overlay").fadeOut();
    }
    function updateTimer() {
// TODO
// if overtime, start playing battle sounds / flashing red randomly
      var timeLeft = ((roundSpeed-(Date.now()-roundStarted))/1000).toFixed(1);

      $("#combatTimerValue").html(timeLeft);
      //$("#combatTimerValue").html((timeLeft>0) ? timeLeft : 0);
    }
    </script>

    <script src="js/fastclick.js"></script>
    <!--<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>-->
  </body>
</html>